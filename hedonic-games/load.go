// loader.go
package main

import (
	"encoding/json"
	"fmt"
	"os"
)

// ============================================================
// –°–¢–†–£–ö–¢–£–†–´ –î–õ–Ø –ó–ê–ì–†–£–ó–ö–ò JSON
// ============================================================

// Node –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —É–∑–µ–ª –≤ JSON —Ñ–∞–π–ª–µ
type Node struct {
	ID string `json:"id"`
}

// Edge –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Ä–µ–±—Ä–æ –≤ JSON —Ñ–∞–π–ª–µ
type Edge struct {
	Source string `json:"source"`
	Target string `json:"target"`
}

// AMteachers –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—Ç —Å—Ç—Ä—É–∫—Ç—É—Ä—É –≥—Ä–∞—Ñ–∞ —É—á–∏—Ç–µ–ª–µ–π –∏–∑ JSON
type AMteachers struct {
	IsDirected   bool        `json:"directed"`
	IsMultigraph bool        `json:"multigraph"`
	GraphData    interface{} `json:"graph"`
	Nodes        []Node      `json:"nodes"`
	Edges        []Edge      `json:"edges"`
}

// ============================================================
// –ó–ê–ì–†–£–ó–ö–ê –ò–ó JSON
// ============================================================

// LoadAMteachers –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≥—Ä–∞—Ñ —É—á–∏—Ç–µ–ª–µ–π –∏–∑ JSON —Ñ–∞–π–ª–∞
//
// –ü–∞—Ä–∞–º–µ—Ç—Ä—ã:
//
//	filePath - –ø—É—Ç—å –∫ JSON —Ñ–∞–π–ª—É ("../ds/relations_graph.json")
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//
//	*AMteachers - —Å—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –∑–∞–≥—Ä—É–∂–µ–Ω–Ω—ã–º–∏ –¥–∞–Ω–Ω—ã–º–∏
//	error - –æ—à–∏–±–∫–∞ –µ—Å–ª–∏ —Ñ–∞–π–ª –Ω–µ –Ω–∞–π–¥–µ–Ω –∏–ª–∏ –Ω–µ–≤–∞–ª–∏–¥–µ–Ω
func LoadAMteachers(filePath string) (*AMteachers, error) {
	// –ß–∏—Ç–∞–µ–º —Ñ–∞–π–ª
	data, err := os.ReadFile(filePath)
	if err != nil {
		return nil, fmt.Errorf("–û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Ñ–∞–π–ª–∞ %s: %w", filePath, err)
	}

	// –†–∞—Å–ø–∞—Ä—Å–∏–≤–∞–µ–º JSON
	var teachers AMteachers
	err = json.Unmarshal(data, &teachers)
	if err != nil {
		return nil, fmt.Errorf("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: %w", err)
	}

	fmt.Printf("–ó–∞–≥—Ä—É–∂–µ–Ω–æ: %d —É–∑–ª–æ–≤ (—É—á–∏—Ç–µ–ª–µ–π), %d —Ä—ë–±–µ—Ä (—Å–≤—è–∑–µ–π)\n",
		len(teachers.Nodes), len(teachers.Edges))

	return &teachers, nil
}

// ============================================================
// –ö–û–ù–í–ï–†–¢–ê–¶–ò–Ø –í –ì–†–ê–§
// ============================================================
//
// –ü—Ä–æ—Ü–µ—Å—Å:
// 1. –°–æ–∑–¥–∞—Ç—å –Ω–æ–≤—ã–π –≥—Ä–∞—Ñ
// 2. –ü—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞—Ç—å –∏–º–µ–Ω–∞ —É—á–∏—Ç–µ–ª–µ–π –≤ —á–∏—Å–ª–æ–≤—ã–µ ID
// 3. –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ —É–∑–ª—ã
// 4. –î–æ–±–∞–≤–∏—Ç—å –≤—Å–µ —Ä—ë–±—Ä–∞
//
// –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç:
//
//	*Graph - –≥—Ä–∞—Ñ –≤ –Ω–∞—à–µ–º —Ñ–æ—Ä–º–∞—Ç–µ
//	map[string]int - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –∏–º—è —É—á–∏—Ç–µ–ª—è ‚Üí —á–∏—Å–ª–æ–≤–æ–π ID
//	map[int]string - —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —á–∏—Å–ª–æ–≤–æ–π ID ‚Üí –∏–º—è —É—á–∏—Ç–µ–ª—è
func (t *AMteachers) ToGraph() (*Graph, map[string]int, map[int]string) {
	g := NewGraph()

	// –°–æ–∑–¥–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ: –∏–º—è —É—á–∏—Ç–µ–ª—è ‚Üí —á–∏—Å–ª–æ–≤–æ–π ID
	nameToID := make(map[string]int)
	idToName := make(map[int]string)

	// –®–∞–≥ 1: –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–µ —É–∑–ª—ã –∏ —Å–æ–∑–¥–∞—Ç—å —Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ
	for i, node := range t.Nodes {
		nameToID[node.ID] = i
		idToName[i] = node.ID
		g.AddNode(i)
	}

	fmt.Printf("\nüìç –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —É–∑–ª–æ–≤:\n")
	for i := 0; i < len(t.Nodes); i++ {
		fmt.Printf("  %d ‚Üí %s\n", i, idToName[i])
	}

	// –®–∞–≥ 2: –¥–æ–±–∞–≤–∏—Ç—å –≤—Å–µ —Ä—ë–±—Ä–∞ (–ø—Ä–µ–æ–±—Ä–∞–∑–æ–≤–∞–≤ –∏–º–µ–Ω–∞ –≤ ID)
	for _, edge := range t.Edges {
		u, ok1 := nameToID[edge.Source]
		v, ok2 := nameToID[edge.Target]

		if ok1 && ok2 {
			g.AddEdge(u, v)
		} else {
			if !ok1 {
				fmt.Printf("‚ö†Ô∏è —É–∑–µ–ª %s –Ω–µ –Ω–∞–π–¥–µ–Ω\n", edge.Source)
			}
			if !ok2 {
				fmt.Printf("‚ö†Ô∏è —É–∑–µ–ª %s –Ω–µ –Ω–∞–π–¥–µ–Ω\n", edge.Target)
			}
		}
	}

	fmt.Printf("\n‚úÖ –ì—Ä–∞—Ñ —Å–æ–∑–¥–∞–Ω: %d —É–∑–ª–æ–≤, %d —Ä—ë–±–µ—Ä\n",
		g.NumNodes(), g.NumEdges())

	return g, nameToID, idToName
}

// ============================================================
// –ó–ê–ì–†–£–ó–ö–ê –ö–õ–ê–°–°–ò–ß–ï–°–ö–ò–• –î–ê–¢–ê–°–ï–¢–û–í (–æ—Å—Ç–∞–≤–ª—è–µ–º –¥–ª—è —Å—Ä–∞–≤–Ω–µ–Ω–∏—è)
// ============================================================

// LoadKarateClub –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≥—Ä–∞—Ñ Zachary Karate Club
// 34 —É–∑–ª–∞, 78 —Ä—ë–±–µ—Ä
func LoadKarateClub() *Graph {
	G := NewGraph()

	edges := [][2]int{
		{0, 1}, {0, 2}, {0, 3}, {0, 4}, {0, 5}, {0, 6}, {0, 7}, {0, 8}, {0, 10}, {0, 11}, {0, 12}, {0, 13}, {0, 17}, {0, 19}, {0, 21}, {0, 31},
		{1, 2}, {1, 3}, {1, 7},
		{2, 3}, {2, 7}, {2, 8}, {2, 13},
		{3, 4}, {3, 6}, {3, 10},
		{4, 5}, {4, 6}, {4, 16},
		{5, 6}, {5, 16},
		{6, 16},
		{8, 9}, {8, 13}, {8, 14}, {8, 15}, {8, 18}, {8, 20}, {8, 22}, {8, 23}, {8, 24}, {8, 25}, {8, 26}, {8, 27}, {8, 28}, {8, 29}, {8, 30}, {8, 31}, {8, 32},
		{9, 13},
		{13, 14}, {13, 15}, {13, 18}, {13, 19}, {13, 20}, {13, 22}, {13, 23}, {13, 24}, {13, 25}, {13, 26}, {13, 27}, {13, 28}, {13, 29}, {13, 30}, {13, 31}, {13, 32}, {13, 33},
		{14, 15}, {14, 18}, {14, 20}, {14, 22}, {14, 23}, {14, 29}, {14, 30}, {14, 31}, {14, 32}, {14, 33},
		{15, 18}, {15, 19}, {15, 20}, {15, 21}, {15, 22}, {15, 23}, {15, 24}, {15, 25}, {15, 26}, {15, 27}, {15, 28}, {15, 29}, {15, 30}, {15, 31}, {15, 32}, {15, 33},
		{18, 19}, {18, 20}, {18, 21}, {18, 22}, {18, 23}, {18, 24}, {18, 25}, {18, 26}, {18, 27}, {18, 28}, {18, 29}, {18, 30}, {18, 31}, {18, 32}, {18, 33},
		{19, 20}, {19, 21}, {19, 22}, {19, 23}, {19, 24}, {19, 25}, {19, 26}, {19, 27}, {19, 28}, {19, 29}, {19, 30}, {19, 31}, {19, 32}, {19, 33},
		{20, 21}, {20, 22}, {20, 23}, {20, 24}, {20, 25}, {20, 26}, {20, 27}, {20, 28}, {20, 29}, {20, 30}, {20, 31}, {20, 32}, {20, 33},
		{21, 22}, {21, 23}, {21, 24}, {21, 25}, {21, 26}, {21, 27}, {21, 28}, {21, 29}, {21, 30}, {21, 31}, {21, 32}, {21, 33},
		{22, 23}, {22, 24}, {22, 25}, {22, 26}, {22, 27}, {22, 28}, {22, 29}, {22, 30}, {22, 31}, {22, 32}, {22, 33},
		{23, 24}, {23, 25}, {23, 26}, {23, 27}, {23, 28}, {23, 29}, {23, 30}, {23, 31}, {23, 32}, {23, 33},
		{24, 25}, {24, 26}, {24, 27}, {24, 28}, {24, 29}, {24, 30}, {24, 31}, {24, 32}, {24, 33},
		{25, 26}, {25, 27}, {25, 28}, {25, 29}, {25, 30}, {25, 31}, {25, 32}, {25, 33},
		{26, 27}, {26, 28}, {26, 29}, {26, 30}, {26, 31}, {26, 32}, {26, 33},
		{27, 28}, {27, 29}, {27, 30}, {27, 31}, {27, 32}, {27, 33},
		{28, 29}, {28, 30}, {28, 31}, {28, 32}, {28, 33},
		{29, 30}, {29, 31}, {29, 32}, {29, 33},
		{30, 31}, {30, 32}, {30, 33},
		{31, 32}, {31, 33},
		{32, 33},
	}

	for _, edge := range edges {
		G.AddEdge(edge[0], edge[1])
	}

	return G
}

// LoadCavemanGraph –∑–∞–≥—Ä—É–∂–∞–µ—Ç –≥—Ä–∞—Ñ "–ø–µ—â–µ—Ä–Ω—ã—Ö –ª—é–¥–µ–π"
func LoadCavemanGraph(numCliques, cliqueSize int) *Graph {
	G := NewGraph()

	nodeID := 0
	for i := 0; i < numCliques; i++ {
		cliqueStart := nodeID

		for j := 0; j < cliqueSize; j++ {
			for k := j + 1; k < cliqueSize; k++ {
				G.AddEdge(cliqueStart+j, cliqueStart+k)
			}
		}

		nodeID += cliqueSize
	}

	for i := 0; i < numCliques-1; i++ {
		G.AddEdge(i*cliqueSize, (i+1)*cliqueSize)
	}

	return G
}

// ============================================================
// –ü–ï–ß–ê–¢–¨ –ò–ù–§–û–†–ú–ê–¶–ò–ò –û –ì–†–ê–§–ï
// ============================================================

// PrintGraphInfo –ø–µ—á–∞—Ç–∞–µ—Ç –ø–æ–¥—Ä–æ–±–Ω—É—é –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ –≥—Ä–∞—Ñ–µ
func PrintGraphInfo(g *Graph, name string, idToName map[int]string) {
	fmt.Printf("üìä –ò–ù–§–û–†–ú–ê–¶–ò–Ø –û –ì–†–ê–§–ï: %s\n", name)
	fmt.Printf("  –£–∑–ª–æ–≤ (—É—á–∏—Ç–µ–ª–µ–π):  %d\n", g.NumNodes())
	fmt.Printf("  –†—ë–±–µ—Ä (—Å–≤—è–∑–µ–π):    %d\n", g.NumEdges())

	if g.NumNodes() > 0 {
		density := float64(2*g.NumEdges()) / float64(g.NumNodes()*(g.NumNodes()-1))
		fmt.Printf("  –ü–ª–æ—Ç–Ω–æ—Å—Ç—å:         %.4f\n", density)

		avgDegree := float64(2*g.NumEdges()) / float64(g.NumNodes())
		fmt.Printf("  –°—Ä–µ–¥–Ω—è—è —Å—Ç–µ–ø–µ–Ω—å:   %.2f\n", avgDegree)
	}

	// –í—ã–≤–µ—Å—Ç–∏ –Ω–µ—Å–∫–æ–ª—å–∫–æ –ø—Ä–∏–º–µ—Ä–æ–≤ —É–∑–ª–æ–≤
	if idToName != nil && len(idToName) > 0 {
		fmt.Printf("\n  –ü—Ä–∏–º–µ—Ä—ã —É–∑–ª–æ–≤ (—É—á–∏—Ç–µ–ª–µ–π):\n")
		count := 0
		for i := 0; i < g.NumNodes() && count < 10; i++ {
			if name, ok := idToName[i]; ok {
				degree := len(g.Edges[i])
				fmt.Printf("    %d: %s (—Å–≤—è–∑–µ–π: %d)\n", i, name, degree)
				count++
			}
		}
	}
}
